#!/bin/bash

PROXY_URL="https://papermc.io/ci/job/Waterfall/lastStableBuild/artifact/Waterfall-Proxy/bootstrap/target/Waterfall.jar"
PAPER_URL="https://papermc.io/ci/job/Paper-1.16/lastStableBuild/artifact/paperclip.jar"
SERVER_PATH=/srv/mc
PROXY_PATH=/srv/proxy
SERVER_NAMES=()
START_FILE=start.sh
RAW_START="https://raw.githubusercontent.com/Lordva/minecraft-server-installer/master/start.sh"
LOG_FILE="raw.txt"
PORT=25565
TIME=$(date +"%T")

eula(){
        read -r -p "Do you accept the eula ? [yes/no]: " key
                case $key in
                        y ) return 0 ;;
                        Y ) return 0 ;;
                        yes ) return 0 ;;
                        YES ) return 0 ;;
                        Yes ) return 0 ;;
                        * ) return 1 ;;
                esac           
}



if [ "$1" = "-c" ]; then
	if [ "$EUID" -ne 0 ]; then
		echo "-------------------------------------------------"
		echo -e "[ERROR] you need to be root to run this script  |"
		echo "-------------------------------------------------"
		echo "Retry with sudo, if you dont have permission please contact your server administrator"
		exit
	fi
	if (( "$#" == "$2 + 2" )); then
		for ((i = 0 ; i+3 <= $# ; i++)); do
			n=$(($i + 3))
			SERVER_NAMES[$i]+=${!n}
		done
		echo "[LOG] you are creating those servers: ${SERVER_NAMES[*]}"
		sleep 1

		for i in ${SERVER_NAMES[@]}; do
			echo "[$(date +"%T") LOG] creating folder ${SERVER_PATH:?}/$i"
			mkdir -p ${SERVER_PATH:?}"/"$i
			if [ ! -d ${SERVER_PATH:?}"/"$i ]; then
				echo -e "[ERROR] The creation of ${SERVER_PATH:?}/$i has failed !"
				exit
			else
				echo "[$(date +"%T") LOG] created ${SERVER_PATH:?}/$i"
				if [ ! -e "paperclip.jar" ]; then
					echo "[$(date +"%T") LOG] Downloading the latest version of PaperMC"
					wget $PAPER_URL >/dev/null 2>&1
					RESULT=$?
					if [ $RESULT != 0 ]; then
						echo "------------------------------------------------------------"
						echo "[ERROR] failed to download the latest stable build of paper|"
						echo "------------------------------------------------------------"
						echo "cleaning the mess before stoping the script"
						rmdir ${SERVER_PATH:?}"/"$i
						exit
					else
						echo "[$(date +"%T") LOG] Successfully downloaded the latest Paper build !"
						sleep 1
					fi
				fi

				cp paperclip.jar ${SERVER_PATH:?}"/$i/server.jar"
				
				if [ -e $START_FILE ]; then
					echo "[$(date +"%T") LOG] $START_FILE exist"
				else
					echo "[$(date +"%T") LOG] $START_FILE doesn't exist, downloading it from GitHub..."
					wget $RAW_START 2>&1 >/dev/null
					chmod +x $START_FILE
					if [ ! -x $START_FILE ]; then
						echo "-------------------------------------------------"
						echo "[ERROR] Download has failed / is not executable |"
						echo "-------------------------------------------------"
						rm -rf ${SERVER_PATH:?}"/"$i
						exit
					else
						echo "[Successfully downloaded/chmod the start.sh script from GitHub]"
					fi
				fi
				cp $START_FILE ${SERVER_PATH:?}"/"$i
				echo "[$(date +"%T") LOG] running the server to generate eula.txt"

				cd ${SERVER_PATH:?}"/"$i
				sh $START_FILE 2>&1 >/dev/null
				RESULT=$?
				if [ $RESULT != 0 ]; then
					echo "---------------------------------------------"
					echo "[ERROR] $START_FILE could not be executed...|"
					echo "---------------------------------------------"
					echo "cleaning the mess before exit"
					rm -rf ${SERVER_PATH:?}"/"$i
					exit
				fi

				if [ ! -e "eula.txt" ]; then
					echo "---------------------------"
					echo "[ERROR] eula.txt not found|"
					echo "---------------------------"
					echo "cleaning the mess before leaving"
					rm -rf ${SERVER_PATH:?}"/"$i
					exit
				else
					echo "[$(date +"%T") LOG] eula.txt was successfully generated"
					echo "[$(date +"%T") LOG] setting eula.txt to True..."
					eula
					RESULT=$?
				fi
				if [ $RESULT != 0 ]; then
					echo "-----------------------------"
					echo "[error] eula wasn't accepted|"
					echo "-----------------------------"
					echo "cleaning mess before leaving"
					rm -rf ${SERVER_PATH:?}"/"$i & exit
				else
					sed -i -e 's/false/true/g' eula.txt
        				RESULT=$?
        				if [ $RESULT != 0 ]; then
                				echo "--------------------------------------"
                				echo "[ERROR] eula could not be set to true|"
                				echo "--------------------------------------"
                				echo "cleaning the mess before leaving"
                				rm -rf ${SERVER_PATH:?}"/"$i & exit
        				else
                				echo "[$(date +"%T") LOG] eula.txt has been successfully set to True"
        				fi

					echo "[$(date +"%T") LOG] Restarting server to complete the install"
					where screen
					if [ $? !=0 ]; then
						echo "[$(date +"%T") LOG] Screen alredy installed"
					else
						
						echo "[$(date +"%T") LOG] Installing screen"
						apt -h
						if [ $? != 0 ]; then
							apt install screen -y 2>&1 >/dev/null
						else
							yum install screen -y 2&1 >/dev/null
						fi
					fi
					echo "[$(date +"%T") LOG] starting screen session"
					screen -DmS mc-$i ./start.sh &
					sleep 15
					screen -p 0 -S mc-$i -X eval 'stuff "stop"\015'
					echo "[$(date +"%T") LOG] Server is fully installed"
				fi
				if [ $2 -lt 2 ]; then
					echo "[INFO] Only one server, no need for a proxy"
				else

					echo "[$(date +"%T") LOG] $2 Server installed, configuring $i for proxy"
					sed -i -e 's/bungeecord: false/bungeecord: true/g' spigot.yml
					RESULT=$?
                                        if [ $RESULT != 0 ]; then
                                                echo "--------------------------------------"
                                                echo "[ERROR] bungeecord be set to true|"
                                                echo "--------------------------------------"
                                                echo "cleaning the mess before leaving"
                                                rm -rf ${SERVER_PATH:?}"/"$i & exit
                                        else
                                                echo "[$(date +"%T") LOG] bungeecord has been successfully set to True"
                                        fi
						
					sed -i -e 's/online-mode=true/online-mode=false/g' server.properties
					RESULT=$?
                                        if [ $RESULT != 0 ]; then
                                                echo "--------------------------------------"
                                                echo "[ERROR] online mode could not be set to false|"
                                                echo "--------------------------------------"
                                                echo "cleaning the mess before leaving"
                                                rm -rf ${SERVER_PATH:?}"/"$i & exit
                                        else
                                                echo "[$(date +"%T") LOG] online mode has been successfully set to false"
                                        fi

					echo "setting port used by server (default is incremented from 25565)"
					PORT=$((PORT+1))
					sed -i -e "s/server-port=25565/server-port=$PORT/g" server.properties
					RESULT=$?
					if [ $RESULT != 0 ]; then
						echo "-----------------------------------------"
						echo "[ERROR] could not change the server port|"
						echo "-----------------------------------------"
						rm -rf ${SERVER_PATH:?}"/"$i & exit
					else
						echo "[$(date +"%T") LOG] the server port has been changed to $PORT"
					fi

					echo "[$(date +"%T") LOG] Server $2 has been configured for proxy"
				fi
			fi
			
		done
		if [ $2 -gt 1 ]; then
			echo "[$(date +"%T") LOG] Begining proxy install"

			echo "[$(date +"%T") LOG] creating folder ${SERVER_PATH:?}"
                        mkdir -p ${PROXY_PATH:?}
                        if [ ! -d ${PROXY_PATH:?} ]; then
                                echo -e "[ERROR] The creation of ${PROXY_PATH:?} has failed !"
                                exit
                        else
                                echo "[$(date +"%T") LOG] created ${PROXY_PATH:?}"
                                if [ ! -e "Waterfall.jar" ]; then
                                        echo "[$(date +"%T") LOG] Downloading the latest version of Waterfall"
                                        wget $PROXY_URL >/dev/null 2>&1
                                        RESULT=$?
                                        if [ $RESULT != 0 ]; then
                                                echo "----------------------------------------------------------------"
                                                echo "[ERROR] failed to download the latest stable build of Waterfall|"
                                                echo "----------------------------------------------------------------"
                                                echo "cleaning the mess before stoping the script"
                                                rmdir ${PROXY_PATH:?}
                                                exit
                                        else
                                                echo "[$(date +"%T") LOG] Successfully downloaded the latest Waterfall build !"
                                                sleep 1
                                        fi
					cp Waterfall.jar ${PROXY_PATH:?}"/proxy.jar"
					cp $START_FILE ${PROXY_PATH:?}
					echo "[$(date +"%T") LOG] Configuring proxy for startup"
					cd ${PROXY_PATH:?}
					sed -i -e 's/server.jar/proxy.jar/g' $START_FILE
					RESULT=$?
                                        if [ $RESULT != 0 ]; then
                                                echo "------------------------------------------"
                                                echo "[ERROR] could not edit start.sh for proxy|"
                                                echo "------------------------------------------"
                                                rm -rf ${SERVER_PATH:?}"/"$i & exit
                                        else
                                                echo "[$(date +"%T") LOG] proxy ready for startup !"
						screen -DmS bungeecord ./start.sh &
						sleep 30
						screen -p 0 -S bungeecord -X eval 'stuff "end"\015'
						echo "[$(date +"%T") LOG] Starting to edit config.yml"

                                        fi
                                fi

			fi
		fi
	else
		echo -e "[ERROR] you must give a name to each servers"
	fi
elif [ "$1" = "-d" ]; then
	echo "this feature has yet to be implemented"
elif [ "$1" = "-u" ]; then
	echo "this feature has yet to be implemented"
elif [ "$1" = "-h" ] || [ "$1" = "-help" ]; then
	echo "help page"
else
	echo -e "[ERROR] Unknow argument, try -h"
fi

